<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aayan MCQ Hub - AI Powered Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #00ffff #000000;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000000;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00ffff;
            border-radius: 4px;
        }
        
        body {
            background: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(25px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: #000000;
            color: #00ffff;
            border: 1px solid #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .btn-primary:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #000000;
            color: #00ff00;
            border: 1px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .btn-success:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #111111;
            color: #ffffff;
            border: 1px solid #444444;
        }
        
        .btn-secondary:hover {
            background: #222222;
            border: 1px solid #666666;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #000000;
            color: #ff0000;
            border: 1px solid #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .card {
            background: #111111;
            border: 1px solid #333333;
            padding: 1.5rem;
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #00ffff, #ff00ff, #00ff00);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        .progress-bar {
            height: 0.5rem;
            background: #222222;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        .option-neutral {
            background: #111111;
            border-left: 4px solid #444444;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .option-neutral::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s;
        }
        
        .option-neutral:hover {
            background: #1a1a1a;
            transform: translateX(5px);
            border-left-color: #666666;
        }
        
        .option-neutral:hover::before {
            transform: translateX(100%);
        }
        
        .option-selected {
            background: #1a1a1a;
            border-left-color: #00ffff;
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.3);
        }
        
        .option-correct {
            background: rgba(0, 255, 0, 0.1);
            border-left-color: #00ff00;
            color: #ffffff;
            animation: pulse-green 1.5s ease-in-out;
        }
        
        .option-wrong {
            background: rgba(255, 0, 0, 0.1);
            border-left-color: #ff0000;
            color: #ffffff;
            animation: shake 0.6s ease-in-out;
        }
        
        .show-correct-answer {
            background: rgba(0, 255, 0, 0.1) !important;
            border-left-color: #00ff00 !important;
            color: #ffffff !important;
            animation: pulse-green 1.5s ease-in-out infinite alternate;
        }
        
        .badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            background: rgba(0, 255, 255, 0.1);
            color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }
        
        .stat-box {
            background: #111111;
            border: 1px solid #333333;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(0, 255, 255, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .stat-box:hover::before {
            opacity: 1;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.4);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(0, 255, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 0, 0);
            }
        }
        
        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }
        
        .neon-icon {
            font-size: 1.5rem;
            color: #00ffff;
            filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.7));
        }
        
        .nav-glow {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            border-bottom: 1px solid #00ffff;
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        .neon-strip {
            height: 3px;
            background: linear-gradient(90deg, #00ffff, #ff00ff, #00ff00);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            margin: 10px 0;
        }
        
        .grid-pattern {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .input-field {
            background: #111111;
            border: 1px solid #333333;
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .neon-pulse {
            animation: neon-pulse 2s infinite alternate;
        }
        
        @keyframes neon-pulse {
            from {
                box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            }
            to {
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.6);
            }
        }
    </style>
</head>
<body class="min-h-screen grid-pattern">
    <nav class="bg-black border-b border-cyan-500 sticky top-0 z-50 nav-glow">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <span class="text-3xl floating">üß†</span>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-cyan-400 text-glow">Aayan MCQ Hub</h1>
                    <p class="text-xs text-gray-400">AI-Powered Learning</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-400">Status:</span>
                <span class="flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-green-400">AI Connected</span>
                </span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6">
        <!-- Upload Section -->
        <div class="card fade-in mb-8 neon-pulse">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold mb-1 flex items-center gap-2">
                        <i class="neon-icon fas fa-file-upload"></i>
                        Upload Past Paper
                    </h2>
                    <p class="text-gray-400 text-sm">Extract MCQs automatically using advanced AI</p>
                </div>
                <span class="text-4xl floating">üìö</span>
            </div>
            
            <form id="uploadForm">
                <div class="mb-6">
                    <div class="relative">
                        <input type="file" id="pdfFile" accept="application/pdf" class="input-field w-full">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <i class="fas fa-file-pdf text-cyan-400"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <i class="fas fa-info-circle text-cyan-400"></i>
                        Supported: PDF files (Max 10MB)
                    </p>
                </div>

                <!-- Answer Key Input -->
                <div class="mb-6">
                    <label class="text-sm text-gray-300 mb-2 block flex items-center gap-1">
                        <i class="fas fa-key text-yellow-400"></i>
                        Answer Key (Optional - leave blank to ask AI)
                    </label>
                    <textarea id="answerKeyInput" class="input-field w-full" placeholder="Format: Q1:A, Q2:B, Q3:C... or leave empty for AI detection" rows="2"></textarea>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display:none;" class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400 flex items-center gap-1">
                            <i class="fas fa-sync-alt loading-spinner text-cyan-400"></i>
                            Processing with AI...
                        </span>
                        <span id="uploadPercent" class="text-sm font-semibold text-cyan-400">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="uploadBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 mb-4 flex-wrap">
                    <button type="submit" class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Upload & Extract
                    </button>
                    <button type="button" class="btn btn-secondary" id="resetUploadBtn">
                        <i class="fas fa-redo"></i>
                        Reset
                    </button>
                </div>
                
                <div id="uploadMsg" class="p-4 rounded-lg" style="display:none;"></div>
            </form>
        </div>

        <!-- Stats Section -->
        <section class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="neon-icon fas fa-chart-bar"></i>
                Learning Dashboard
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stat-box">
                    <div class="flex justify-center mb-2">
                        <i class="fas fa-question-circle text-3xl text-cyan-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Total Questions</p>
                    <p class="text-3xl font-bold text-cyan-400" id="totalQuestions">0</p>
                </div>
                <div class="stat-box">
                    <div class="flex justify-center mb-2">
                        <i class="fas fa-check-circle text-3xl text-green-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Answered</p>
                    <p class="text-3xl font-bold text-green-400" id="answeredQuestions">0</p>
                </div>
                <div class="stat-box">
                    <div class="flex justify-center mb-2">
                        <i class="fas fa-star text-3xl text-purple-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Correct</p>
                    <p class="text-3xl font-bold text-purple-400" id="correctQuestions">0</p>
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quizSection" style="display:none;" class="fade-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="neon-icon fas fa-brain"></i>
                    AI Quiz Challenge
                </h2>
                <button class="btn btn-secondary text-sm" id="resetQuizBtn">
                    <i class="fas fa-sync-alt"></i>
                    New Quiz
                </button>
            </div>
            
            <!-- Quiz Progress -->
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-gray-400 flex items-center gap-1">
                        <i class="fas fa-tasks text-cyan-400"></i>
                        Progress
                    </span>
                    <span id="quizProgress" class="text-sm font-semibold text-cyan-400">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="quizProgressBar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Single Question Slide -->
            <div id="quizSlide" class="card slide-in">
                <div id="slideContent"></div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex gap-3 mt-6 justify-between flex-wrap">
                <button class="btn btn-secondary" id="prevBtn" style="display:none;">
                    <i class="fas fa-arrow-left"></i>
                    Previous
                </button>
                <button class="btn btn-primary" id="submitCurrentBtn">
                    <i class="fas fa-check"></i>
                    Submit & Next
                </button>
                <button class="btn btn-success" id="finishBtn" style="display:none;">
                    <i class="fas fa-flag-checkered"></i>
                    End Test
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 mt-4 justify-center flex-wrap">
                <button class="btn btn-secondary text-sm" id="clearAllBtn">
                    <i class="fas fa-trash-alt"></i>
                    Clear All
                </button>
            </div>
        </section>

        <!-- Empty State -->
        <section id="emptyState" class="card text-center py-12">
            <p class="text-5xl mb-4 floating">üìù</p>
            <h3 class="text-xl font-bold text-gray-300 mb-2">Ready to Begin Your Journey?</h3>
            <p class="text-gray-400 mb-6">Upload a PDF to start your AI-powered learning experience!</p>
            <div class="flex justify-center gap-2 text-cyan-400">
                <i class="fas fa-robot text-2xl"></i>
                <i class="fas fa-bolt text-2xl"></i>
                <i class="fas fa-atom text-2xl"></i>
            </div>
        </section>
    </main>

    <footer class="border-t border-cyan-500/30 mt-12 py-8 text-center text-gray-500 text-sm">
        <p class="text-lg font-semibold text-cyan-400 mb-2">üß† Aayan MCQ Hub</p>
        <p class="text-gray-400 mb-1">¬© 2025 | AI-Powered Learning Platform</p>
        <p class="text-gray-400">Backend: <span class="text-green-400 flex items-center justify-center gap-1"><i class="fas fa-circle text-xs"></i> Connected</span></p>
    </footer>

    <script>
        const API_BASE = "https://quiz-production-cf4b.up.railway.app";
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let quizState = { answers: {}, submitted: false, score: 0 };
        let quizStarted = false;

        // ===== API CALLS =====
        async function checkBackendHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                return res.ok;
            } catch { return false; }
        }

        async function fetchQuestions() {
            try {
                const res = await fetch(`${API_BASE}/questions`);
                if (!res.ok) throw new Error("Failed to fetch");
                const data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch (err) {
                console.error("Error:", err);
                showError("Failed to load questions");
                return [];
            }
        }

        async function uploadPdf(file, answerKey) {
            try {
                const formData = new FormData();
                formData.append("file", file);
                
                showUploadProgress();
                let progress = 0;
                const progressInterval = setInterval(() => {
                    if (progress < 80) {
                        progress += Math.random() * 15;
                        if (progress > 80) progress = 80;
                        document.getElementById("uploadPercent").textContent = Math.round(progress) + "%";
                        document.getElementById("uploadBar").style.width = Math.round(progress) + "%";
                    }
                }, 500);
                
                console.log("üì§ Uploading:", file.name);
                const res = await fetch(`${API_BASE}/upload`, { method: "POST", body: formData });
                clearInterval(progressInterval);
                
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `Failed: ${res.status}`);
                }
                
                const data = await res.json();
                console.log("‚úÖ Upload complete, validating with AI...");
                
                // AI-FIRST: Validate raw text before using extracted questions
                document.getElementById("uploadPercent").textContent = "85%";
                document.getElementById("uploadBar").style.width = "85%";
                
                // Get raw text from PDF for AI validation
                const rawText = await extractRawTextFromPdf(file);
                if (rawText && rawText.length > 50) {
                    console.log("ü§ñ Sending raw text to AI for validation...");
                    const validationRes = await fetch(`${API_BASE}/assistant/validate-raw-text`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ raw_text: rawText })
                    });
                    
                    if (validationRes.ok) {
                        const validation = await validationRes.json();
                        console.log("‚úÖ AI validation result:", validation);
                        if (validation.questions && validation.questions.length > 0) {
                            console.log(`‚úÖ AI structured ${validation.questions.length} questions`);
                        }
                    }
                }
                
                document.getElementById("uploadPercent").textContent = "100%";
                document.getElementById("uploadBar").style.width = "100%";
                
                return { ...data, answerKey };
            } catch (err) {
                console.error("Upload error:", err);
                throw err;
            }
        }

        async function extractRawTextFromPdf(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Use pdfjs to extract text
                        const pdfjsLib = window['pdfjs-dist/build/pdf'];
                        if (!pdfjsLib) {
                            resolve("");
                            return;
                        }
                        
                        const pdf = await pdfjsLib.getDocument(e.target.result).promise;
                        let text = "";
                        for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + "\n";
                        }
                        resolve(text);
                    } catch (err) {
                        console.error("PDF text extraction error:", err);
                        resolve("");
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function validateWithAI(questions) {
            try {
                const res = await fetch(`${API_BASE}/assistant/validate`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(questions.slice(0, 5))
                });
                if (!res.ok) throw new Error("Validation failed");
                return await res.json();
            } catch (err) {
                console.error("Validation error:", err);
                return null;
            }
        }

        async function getAnswersFromGroq(questions) {
            try {
                const prompt = `Given these MCQ questions, provide the correct answers in format: Q1:A, Q2:B, etc.\n\n${JSON.stringify(questions.slice(0, 10), null, 2)}`;
                const res = await fetch(`${API_BASE}/assistant/explain`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question_id: 0 })
                });
                if (!res.ok) throw new Error("Failed");
                return await res.json();
            } catch (err) {
                console.error("Error:", err);
                return null;
            }
        }

        async function deleteAllQuestions() {
            try {
                const res = await fetch(`${API_BASE}/questions/all`, { method: "DELETE" });
                if (!res.ok) throw new Error("Delete failed");
                return await res.json();
            } catch (err) {
                console.error("Delete error:", err);
                throw err;
            }
        }

        // ===== UI FUNCTIONS =====
        function showUploadProgress() {
            document.getElementById("uploadProgress").style.display = "block";
            document.getElementById("uploadMsg").style.display = "none";
        }

        function hideUploadProgress() {
            setTimeout(() => {
                document.getElementById("uploadProgress").style.display = "none";
            }, 1000);
        }

        function showMessage(msg, type = "success") {
            const msgDiv = document.getElementById("uploadMsg");
            msgDiv.style.display = "block";
            if (type === "success") {
                msgDiv.className = "p-4 rounded-lg bg-emerald-900/30 border border-emerald-500 text-emerald-100";
                msgDiv.innerHTML = `‚úÖ ${msg}`;
            } else {
                msgDiv.className = "p-4 rounded-lg bg-red-900/30 border border-red-500 text-red-100";
                msgDiv.innerHTML = `‚ùå ${msg}`;
            }
        }

        function showError(msg) {
            showMessage(msg, "error");
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== QUIZ LOGIC =====
        async function loadQuestions() {
            const questions = await fetchQuestions();
            allQuestions = questions.filter(q => q && q.id);
            
            document.getElementById("totalQuestions").textContent = allQuestions.length;
            document.getElementById("answeredQuestions").textContent = "0";
            document.getElementById("correctQuestions").textContent = "0";
            
            if (allQuestions.length === 0) {
                document.getElementById("emptyState").style.display = "block";
                document.getElementById("quizSection").style.display = "none";
            } else {
                document.getElementById("emptyState").style.display = "none";
                document.getElementById("quizSection").style.display = "block";
                startQuiz();
            }
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            quizState = { answers: {}, submitted: false, score: 0 };
            quizStarted = true;
            renderCurrentQuestion();
        }

        function renderCurrentQuestion() {
            if (currentQuestionIndex >= allQuestions.length) {
                finishQuiz();
                return;
            }

            const q = allQuestions[currentQuestionIndex];
            const slideContent = document.getElementById("slideContent");
            
            slideContent.innerHTML = `
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <div class="badge mb-3">Question ${currentQuestionIndex + 1}/${allQuestions.length}</div>
                        <p class="text-2xl font-semibold text-gray-100">${escapeHtml(q.question)}</p>
                    </div>
                </div>
                
                <div class="space-y-3 mb-6" id="options-container">
                    ${(q.options || []).map((opt, i) => `
                        <label class="option-neutral flex items-center gap-3 cursor-pointer" onclick="selectOption(${i})">
                            <input type="radio" name="answer" value="${i}" class="w-4 h-4">
                            <span class="flex-1 text-lg">${escapeHtml(opt)}</span>
                        </label>
                    `).join("")}
                </div>
                
                <div class="flex gap-2 flex-wrap mb-6">
                    <button class="btn text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-2" onclick="getHint(${q.id})">
                        <span>üí°</span> Hint
                    </button>
                    <button class="btn text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-2" onclick="getExplanation(${q.id})">
                        <span>üìñ</span> Explain
                    </button>
                </div>
                
                <div id="hint-${q.id}" class="bg-purple-900/30 border border-purple-500/50 text-purple-100 p-3 rounded-lg text-sm" style="display:none;"></div>
                <div id="explanation-${q.id}" class="bg-blue-900/30 border border-blue-500/50 text-blue-100 p-3 rounded-lg text-sm" style="display:none;"></div>
            `;

            updateNavButtons();
            updateProgress();
        }

        function selectOption(index) {
            const q = allQuestions[currentQuestionIndex];
            quizState.answers[q.id] = index;
            
            const options = document.querySelectorAll("#options-container label");
            options.forEach((opt, i) => {
                opt.classList.remove("option-selected");
                if (i === index) opt.classList.add("option-selected");
            });
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("submitCurrentBtn");
            const finishBtn = document.getElementById("finishBtn");

            // Always show the submit button
            nextBtn.style.display = "inline-flex";
            // Show previous button only if not on first question
            prevBtn.style.display = currentQuestionIndex > 0 ? "inline-flex" : "none";
            
            // Update button text for last question
            if (currentQuestionIndex === allQuestions.length - 1) {
                nextBtn.textContent = "‚úÖ Submit & Finish";
                finishBtn.style.display = "none";
            } else {
                nextBtn.textContent = "‚úÖ Submit & Next";
                finishBtn.style.display = "none";
            }
        }

        function updateProgress() {
            const answered = Object.keys(quizState.answers).length;
            const total = allQuestions.length;
            document.getElementById("quizProgress").textContent = `${answered}/${total}`;
            document.getElementById("quizProgressBar").style.width = (answered / total * 100) + "%";
        }

        function finishQuiz() {
            const scoreDiv = document.getElementById("slideContent");
            scoreDiv.innerHTML = `
                <div class="text-center py-12">
                    <p class="text-6xl mb-6">üéâ</p>
                    <p class="text-gray-400 mb-2">Quiz Completed!</p>
                    <p class="text-5xl font-bold text-indigo-400 mb-2">${quizState.score}/${allQuestions.length}</p>
                    <p class="text-gray-400 mb-8">${Math.round(quizState.score/allQuestions.length*100)}% Correct</p>
                    <button class="btn btn-primary" onclick="startQuiz()">
                        <span>üîÑ</span> Try Again
                    </button>
                </div>
            `;
            document.getElementById("prevBtn").style.display = "none";
            document.getElementById("submitCurrentBtn").style.display = "none";
            document.getElementById("finishBtn").style.display = "none";
        }

        async function getHint(questionId) {
            const hintDiv = document.getElementById(`hint-${questionId}`);
            if (!hintDiv) return;
            hintDiv.innerHTML = '<span class="loading-spinner">‚è≥</span> Getting hint...';
            hintDiv.style.display = "block";
            
            try {
                const res = await fetch(`${API_BASE}/assistant/hint?question_id=${questionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                hintDiv.innerHTML = `<strong class="text-purple-300">üí° Hint:</strong><br>${escapeHtml(data.hint || "No hint available")}`;
            } catch (err) {
                console.error("Hint error:", err);
                hintDiv.innerHTML = `<strong class="text-red-300">‚ö†Ô∏è Error: ${err.message}</strong>`;
            }
        }

        async function getExplanation(questionId) {
            const expDiv = document.getElementById(`explanation-${questionId}`);
            if (!expDiv) return;
            expDiv.innerHTML = '<span class="loading-spinner">‚è≥</span> Generating...';
            expDiv.style.display = "block";
            
            try {
                const res = await fetch(`${API_BASE}/assistant/explain?question_id=${questionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                expDiv.innerHTML = `<strong class="text-blue-300">üìñ Explanation:</strong><br>${escapeHtml(data.explanation || "No explanation available")}`;
            } catch (err) {
                console.error("Explanation error:", err);
                expDiv.innerHTML = `<strong class="text-red-300">‚ö†Ô∏è Error: ${err.message}</strong>`;
            }
        }

        // ===== EVENT LISTENERS =====
        document.getElementById("uploadForm").onsubmit = async (e) => {
            e.preventDefault();
            const file = document.getElementById("pdfFile").files[0];
            if (!file) {
                showError("Choose a PDF file");
                return;
            }
            
            document.getElementById("uploadBtn").disabled = true;
            
            try {
                const answerKey = document.getElementById("answerKeyInput").value.trim();
                const data = await uploadPdf(file, answerKey);
                hideUploadProgress();
                showMessage(`‚úÖ ${data.saved_count} questions extracted!`);
                document.getElementById("pdfFile").value = "";
                document.getElementById("answerKeyInput").value = "";
                
                // Validate with AI
                showMessage("ü§ñ Validating with AI...");
                const validation = await validateWithAI(allQuestions);
                if (validation) {
                    showMessage(`‚úÖ Validation: ${validation.message}`);
                }
                
                await new Promise(r => setTimeout(r, 1500));
                await loadQuestions();
            } catch (err) {
                hideUploadProgress();
                showError(err.message);
            } finally {
                document.getElementById("uploadBtn").disabled = false;
            }
        };

        document.getElementById("resetUploadBtn").onclick = () => {
            document.getElementById("pdfFile").value = "";
            document.getElementById("answerKeyInput").value = "";
            document.getElementById("uploadMsg").style.display = "none";
        };

        document.getElementById("resetQuizBtn").onclick = () => startQuiz();

        document.getElementById("submitCurrentBtn").onclick = () => {
            const btn = document.getElementById("submitCurrentBtn");
            if (btn.disabled) return; // Prevent multiple clicks
            
            const q = allQuestions[currentQuestionIndex];
            if (quizState.answers[q.id] === undefined) {
                showError("Please select an answer first!");
                return;
            }
            
            btn.disabled = true; // Disable button immediately
            
            const picked = quizState.answers[q.id];
            const isCorrect = picked === q.correct_option;
            
            // Update score if correct
            if (isCorrect) {
                quizState.score++;
                document.getElementById("correctQuestions").textContent = quizState.score;
            }
            
            // Update answered count
            document.getElementById("answeredQuestions").textContent = 
                Object.keys(quizState.answers).length;
            
            // Show visual feedback
            const options = document.querySelectorAll("#options-container label");
            options[picked].classList.add(isCorrect ? "option-correct" : "option-wrong");
            
            // Show correct answer if wrong
            if (!isCorrect && q.correct_option !== undefined) {
                options[q.correct_option].classList.add("show-correct-answer");
            }
            
            // Show feedback with explanation if available
            let feedbackMsg = isCorrect ? "‚úÖ Correct!" : "‚ùå Incorrect";
            if (q.explanation) {
                feedbackMsg += `\n\n${q.explanation}`;
            }
            showMessage(feedbackMsg, isCorrect ? "success" : "error");
            
            // Auto-next after 2 seconds
            setTimeout(() => {
                currentQuestionIndex++;
                btn.disabled = false; // Re-enable for next question
                renderCurrentQuestion();
            }, 1500);
        };

        document.getElementById("prevBtn").onclick = () => {
            currentQuestionIndex--;
            renderCurrentQuestion();
        };

        document.getElementById("finishBtn").onclick = () => finishQuiz();

        document.getElementById("clearAllBtn").onclick = async () => {
            if (!confirm("Delete ALL questions?")) return;
            try {
                const data = await deleteAllQuestions();
                showMessage(`‚úÖ Deleted ${data.deleted_count} questions`);
                await loadQuestions();
            } catch (err) {
                showError("Delete failed");
            }
        };

        // Initialize
        (async () => {
            const healthy = await checkBackendHealth();
            if (!healthy) showError("Cannot connect to backend!");
            await loadQuestions();
        })();
    </script>
</body>
</html>
